#!/bin/bash
# PumaGuard DHCP Notification Script
# Called by dnsmasq when DHCP lease events occur
#
# Arguments passed by dnsmasq:
# $1 = action (add, old, del)
# $2 = MAC address
# $3 = IP address
# $4 = hostname (if provided by client)

ACTION="$1"
MAC="$2"
IP="$3"
HOSTNAME="${4:-unknown}"

# PumaGuard API endpoint
PUMAGUARD_API="http://{{ dnsmasq_gateway }}:5000/api"

# Device hostnames to track
CAMERA_HOSTNAME_PREFIX="Microseven"
PLUG_HOSTNAME_PREFIX="shellyplug"

# Function to log messages to journald
log_message() {
    echo "$*" | systemd-cat -t pumaguard-dhcp-notify -p info
}

# Function to notify PumaGuard API
notify_pumaguard() {
    local action="$1"
    local mac="$2"
    local ip="$3"
    local hostname="$4"

    # Create JSON payload
    local json_payload=$(cat <<EOF
{
  "action": "$action",
  "mac_address": "$mac",
  "ip_address": "$ip",
  "hostname": "$hostname",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF
)

    # Send to PumaGuard API
    curl -X POST \
        -H "Content-Type: application/json" \
        -d "$json_payload" \
        "$PUMAGUARD_API/dhcp/event" \
        --silent \
        --max-time 5 \
        2>&1 | systemd-cat -t pumaguard-dhcp-notify -p debug
}

# Main logic
case "$ACTION" in
    add|old)
        # Device connected or renewed lease
        log_message "DHCP $ACTION: hostname=$HOSTNAME, mac=$MAC, ip=$IP"

        # Check if this is a camera we're tracking
        if [[ "$HOSTNAME" == "$CAMERA_HOSTNAME_PREFIX"* ]]; then
            log_message "Camera detected: $HOSTNAME at $IP"
            notify_pumaguard "$ACTION" "$MAC" "$IP" "$HOSTNAME"
        # Check if this is a plug we're tracking
        elif [[ "${HOSTNAME,,}" == "$PLUG_HOSTNAME_PREFIX"* ]]; then
            log_message "Plug detected: $HOSTNAME at $IP"
            notify_pumaguard "$ACTION" "$MAC" "$IP" "$HOSTNAME"
        fi
        ;;
    del)
        # Device disconnected
        log_message "DHCP $ACTION: hostname=$HOSTNAME, mac=$MAC, ip=$IP"

        # Check if this is a camera
        if [[ "$HOSTNAME" == "$CAMERA_HOSTNAME_PREFIX"* ]]; then
            log_message "Camera disconnected: $HOSTNAME"
            notify_pumaguard "$ACTION" "$MAC" "$IP" "$HOSTNAME"
        # Check if this is a plug
        elif [[ "${HOSTNAME,,}" == "$PLUG_HOSTNAME_PREFIX"* ]]; then
            log_message "Plug disconnected: $HOSTNAME"
            notify_pumaguard "$ACTION" "$MAC" "$IP" "$HOSTNAME"
        fi
        ;;
    *)
        log_message "Unknown action: $ACTION"
        ;;
esac

exit 0
